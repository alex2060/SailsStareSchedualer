<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CSV Worker Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .status-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 20px; margin-bottom: 30px; }
    .status-card { background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; border-left: 4px solid #007bff; }
    .status-card.running { border-left-color: #28a745; }
    .status-card.stopped { border-left-color: #dc3545; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 30px; }
    .controls input, .controls button { padding: 5px; }
    button { border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .btn-primary { background: #007bff; color: #fff; }
    .btn-success { background: #28a745; color: #fff; }
    .btn-danger  { background: #dc3545; color: #fff; }
    .btn-info   { background: #17a2b8; color: #fff; }
    .section { margin-bottom: 30px; }
    .card { background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; }
    .status-healthy { color: #28a745; font-weight: bold; }
    .status-error   { color: #dc3545; font-weight: bold; }
    .status-unknown { color: #6c757d; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }
    pre { background: #f1f3f4; padding: 10px; border-radius: 4px; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>CSV Worker Dashboard</h1></div>

    <div class="status-grid" id="status-grid"></div>

    <div class="controls">
      <label>Workers: <input type="number" id="num-workers" value="2" min="1" max="10"></label>
      <label>Watch Dir: <input type="text" id="watch-dir" value="loading_csv"></label>
      <label>Upload CSV: <input type="file" id="file-input" accept=".csv,.task"></label>
      <button class="btn-primary" onclick="uploadFile()">Upload</button>
      <button class="btn-success" onclick="startWorkers()">Start</button>
      <button class="btn-danger" onclick="stopWorkers()">Stop</button>
      <button class="btn-info" onclick="refreshStatus()">Refresh</button>
      <button class="btn-info" onclick="toggleLogs()">Logs</button>
    </div>

    <div class="section">
      <h3>External Health Check</h3>
      <div class="card">
        <div><strong>URL:</strong> <span id="health-url">â€”</span></div>
        <div><strong>Status:</strong> <span id="health-status" class="status-unknown">Unknown</span></div>
        <div id="health-response" style="display:none; margin-top:10px;">
          <strong>Response:</strong>
          <pre id="health-response-text"></pre>
        </div>
        <button class="btn-info" onclick="checkExternalHealth()">Test Health</button>
      </div>
    </div>

    <div class="section">
      <h3>Files</h3>
      <div class="card">
        <button class="btn-info" onclick="refreshFiles()">Refresh File List</button>
        <table id="files-table">
          <thead>
            <tr><th>Filename</th><th>Size (bytes)</th><th>Status</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h3>API Logs</h3>
      <div class="card">
        <div id="logs-container" style="display:none;">
          <pre id="logs-text"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';

    async function apiCall(endpoint, method='GET', data) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (data) opts.body = JSON.stringify(data);
      const res = await fetch(API_BASE + endpoint, opts);
      return res.json();
    }

    function renderStatus(d) {
      const grid = document.getElementById('status-grid');
      grid.innerHTML = '';
      [
        ['Running', d.running],
        ['Workers', d.num_workers],
        ['Active', d.active_workers],
        ['Total Files', d.total_files_processed],
        ['Pending', d.files_pending],
        ['Processing', d.files_processing],
        ['Completed', d.files_completed],
        ['Errors', d.files_error],
        ['Uptime', d.uptime]
      ].forEach(([label, val]) => {
        const c = document.createElement('div');
        c.className = 'status-card ' + (label==='Running'?(val?'running':'stopped'):'');
        c.innerHTML = `<h4>${label}</h4><p>${val}</p>`;
        grid.appendChild(c);
      });
    }

    async function refreshStatus() {
      const s = await apiCall('/status');
      renderStatus(s);
    }

    async function startWorkers() {
      const data = {
        num_workers: +document.getElementById('num-workers').value || 2,
        watch_directory: document.getElementById('watch-dir').value || 'loading_csv'
      };
      const r = await apiCall('/start','POST',data);
      alert(r.error?`Start failed: ${r.error}`:'Started');
      refreshStatus();
    }

    async function stopWorkers() {
      const r = await apiCall('/stop','POST');
      alert(r.error?`Stop failed: ${r.error}`:'Stopped');
      refreshStatus();
    }

    async function uploadFile() {
      const inp = document.getElementById('file-input');
      if (!inp.files.length) return alert('Select a file');
      const f = inp.files[0];
      const fd = new FormData();
      fd.append('file', f);
      const res = await fetch(API_BASE + '/upload', { method:'POST', body: fd });
      const j = await res.json();
      alert(j.error?`Upload error: ${j.error}`:j.message);
      refreshFiles();
      refreshStatus();
    }

    async function refreshFiles() {
      const result = await apiCall('/files');
      const tbody = document.querySelector('#files-table tbody');
      tbody.innerHTML = '';
      result.files.forEach(file => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${file.filename}</td>
          <td>${file.size}</td>
          <td>${file.status}</td>
          <td><button class="btn-danger" onclick="deleteFile('${file.filename}')">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function deleteFile(name) {
      if (!confirm(`Delete ${name}?`)) return;
      const r = await apiCall('/delete','POST',{ filename: name });
      alert(r.error?`Delete failed: ${r.error}`:r.message);
      refreshFiles();
      refreshStatus();
    }

    async function loadConfig() {
      const c = await apiCall('/config');
      if (!c.error) document.getElementById('health-url').textContent = c.health_check_url;
    }

    async function checkExternalHealth() {
      const btn = event.target;
      btn.disabled = true; btn.textContent='Testing...';
      const h = await apiCall('/health-check');
      const st = document.getElementById('health-status');
      if (h.error) {
        st.textContent='Error'; st.className='status-error';
      } else {
        st.textContent=h.status; st.className=h.status==='healthy'?'status-healthy':'status-error';
      }
      document.getElementById('health-response').style.display='block';
      document.getElementById('health-response-text').textContent=JSON.stringify(h,null,2);
      btn.disabled=false; btn.textContent='Test Health';
    }

    async function toggleLogs() {
      const cont = document.getElementById('logs-container');
      if (cont.style.display==='block') {
        cont.style.display='none';
      } else {
        cont.style.display='block';
        document.getElementById('logs-text').textContent='Loading...';
        const l = await apiCall('/logs');
        document.getElementById('logs-text').textContent = l.error ? `Error: ${l.error}` : l.logs.join('\n');
      }
    }

    window.onload = () => {
      loadConfig();
      refreshStatus();
      refreshFiles();
      setInterval(() => { refreshStatus(); refreshFiles(); }, 6000);
    };
  </script>
</body>
</html>
